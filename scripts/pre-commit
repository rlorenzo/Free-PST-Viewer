#!/bin/bash
# Pre-commit hook: runs SwiftLint on staged Swift files

if ! command -v swiftlint &> /dev/null; then
    echo "warning: SwiftLint not installed. Skipping lint check."
    echo "Install with: brew install swiftlint"
    exit 0
fi

STAGED_SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACMR -- '*.swift')

if [ -z "$STAGED_SWIFT_FILES" ]; then
    exit 0
fi

echo "Running SwiftLint on staged Swift files..."

LINT_FAILED=0
while IFS= read -r file; do
    if [ -f "$file" ]; then
        tmp_file=$(mktemp "${TMPDIR:-/tmp}/swiftlint-XXXXXX.swift")
        git show ":$file" > "$tmp_file"
        swiftlint lint --strict --path "$tmp_file"
        lint_result=$?
        rm -f "$tmp_file"
        if [ $lint_result -ne 0 ]; then
            LINT_FAILED=1
        fi
    fi
done <<< "$STAGED_SWIFT_FILES"

if [ $LINT_FAILED -ne 0 ]; then
    echo "SwiftLint violations found. Please fix them before committing."
    exit 1
fi

exit 0
