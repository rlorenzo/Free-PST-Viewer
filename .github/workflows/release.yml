name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: macos-15
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer

      - name: Resolve SPM dependencies
        run: xcodebuild -resolvePackageDependencies -project FreePSTViewer.xcodeproj -scheme FreePSTViewer

      - name: Archive
        run: |
          xcodebuild archive \
            -project FreePSTViewer.xcodeproj \
            -scheme FreePSTViewer \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/FreePSTViewer.xcarchive" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_ALLOWED=NO

      - name: Export app from archive
        run: |
          APP_PATH=$(find "$RUNNER_TEMP/FreePSTViewer.xcarchive" -name "*.app" -type d | head -1)
          echo "Found app at: $APP_PATH"
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: No .app found in archive. Archive contents:"
            find "$RUNNER_TEMP/FreePSTViewer.xcarchive" -maxdepth 4
            exit 1
          fi
          cp -R "$APP_PATH" "$RUNNER_TEMP/Free PST Viewer.app"

      - name: Stage DMG contents
        run: |
          mkdir "$RUNNER_TEMP/dmg-stage"
          cp -R "$RUNNER_TEMP/Free PST Viewer.app" "$RUNNER_TEMP/dmg-stage/"
          cat > "$RUNNER_TEMP/dmg-stage/README FIRST.txt" << 'README'
          ╔══════════════════════════════════════════════════════╗
          ║           Free PST Viewer — Installation            ║
          ╚══════════════════════════════════════════════════════╝

          1. Drag "Free PST Viewer.app" to your Applications folder.

          2. Open Terminal and run:

               xattr -cr "/Applications/Free PST Viewer.app"

          3. Right-click (or Control-click) the app and choose "Open".

          4. Click "Open" in the security dialog.

          WHY IS THIS NEEDED?
          This app is free and open-source but is not signed with an
          Apple Developer certificate. macOS quarantines unsigned apps
          downloaded from the internet. The xattr command removes the
          quarantine flag. You only need to do this once.

          Source code: https://github.com/rlorenzo/Free-PST-Viewer
          README

      - name: Create DMG
        run: |
          hdiutil create -volname "Free PST Viewer" \
            -srcfolder "$RUNNER_TEMP/dmg-stage" \
            -ov -format UDZO \
            "$RUNNER_TEMP/FreePSTViewer.dmg"

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ runner.temp }}/FreePSTViewer.dmg
          generate_release_notes: true
          body: |
            ## Installation

            1. Download **FreePSTViewer.dmg** below
            2. Open the `.dmg` and drag **Free PST Viewer** to your Applications folder
            3. Open **Terminal** and run:
               ```
               xattr -cr "/Applications/Free PST Viewer.app"
               ```
            4. Right-click (or Control-click) the app and choose **Open**
            5. Click **Open** in the security dialog

            > **Why the extra step?** This app is free and open-source but is not signed with an Apple Developer certificate. macOS quarantines unsigned apps downloaded from the internet. The `xattr` command removes the quarantine flag. You only need to do this once.
